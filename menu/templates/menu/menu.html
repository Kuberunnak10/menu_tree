{# Шаблон для отрисовки древовидного меню #}
{% if menu_structure %}
    {% for item, children in menu_structure %}
        <li {% if item.is_active %}class="active"{% endif %}>
            <a href="{{ item.url_resolved }}">{{ item.title }}</a>
            {% if children %}
                {% if item.id in expanded_ids %}
                    {# Разворачиваем детей для предков активного пункта #}
                    <ul>
                        {% for child, grandchildren in children %}
                            <li {% if child.is_active %}class="active"{% endif %}>
                                <a href="{{ child.url_resolved }}">{{ child.title }}</a>
                                {% if grandchildren %}
                                    <ul>
                                        {% for grandchild, great_grandchildren in grandchildren %}
                                            <li {% if grandchild.is_active %}class="active"{% endif %}>
                                                <a href="{{ grandchild.url_resolved }}">{{ grandchild.title }}</a>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                {% endif %}
                            </li>
                        {% endfor %}
                    </ul>
                {% elif item.is_active %}
                    {# Для активного узла показываем только первый уровень детей #}
                    <ul>
                        {% for child, grandchildren in children %}
                            <li {% if child.is_active %}class="active"{% endif %}>
                                <a href="{{ child.url_resolved }}">{{ child.title }}</a>
                            </li>
                        {% endfor %}
                    </ul>
                {% endif %}
            {% endif %}
        </li>
    {% endfor %}
{% endif %}